document.addEventListener('DOMContentLoaded', () => {
    // Cargar total del carrito
    loadCartTotal();
    
    // Formateo de campos
    setupCardFormatting();
    
    // Event listener para agregar tarjeta
    document.getElementById('btnAddCard')?.addEventListener('click', (e) => {
        e.preventDefault();
        
        const form = document.getElementById('paymentForm');
        if (form.checkValidity()) {
            // Aquí iría la lógica para guardar el método de pago
            alert('Método de pago agregado exitosamente');
            window.location.href = '/checkout.html';
        } else {
            alert('Por favor completa todos los campos');
            form.reportValidity();
        }
    });
});

function loadCartTotal() {
    const savedCart = localStorage.getItem('mielCart');
    if (savedCart) {
        try {
            const items = JSON.parse(savedCart);
            const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalElement = document.getElementById('addPaymentTotal');
            if (totalElement) {
                totalElement.textContent = `$${total.toFixed(2)}`;
            }
        } catch (error) {
            console.error('Error loading cart:', error);
        }
    }
}

function setupCardFormatting() {
    // Formateo del número de tarjeta
    const cardNumber = document.getElementById('cardNumber');
    cardNumber?.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\s/g, '');
        value = value.replace(/\D/g, '');
        value = value.replace(/(\d{4})/g, '$1 ').trim();
        e.target.value = value;
    });
    
    // Formateo de MM/AA
    const cardMonth = document.getElementById('cardMonth');
    const cardExpiry = document.getElementById('cardExpiry');
    
    [cardMonth, cardExpiry].forEach(input => {
        input?.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });
    });
    
    // Solo números en CVV
    const cardCVV = document.getElementById('cardCVV');
    cardCVV?.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/\D/g, '');
    });
    
    // Solo letras en nombre
    const cardName = document.getElementById('cardName');
    cardName?.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
    });
}